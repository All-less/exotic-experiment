<html>
<body>
    <h1>Welcome, {{nickname}}</h1>
    <p>rtmpserver : {{rtmpserver}}, streamName : {{streamName}}</p>
    <button onclick='server.user.acquire()'>acquire</button>
    <button onclick='server.user.release()'>release</button>
    <form action='./file' enctype="multipart/form-data" method='post' target= "hframe">
        <input type='file' name='file' id='file' />
        <input type='submit' name='submit' value='Upload'/>
		{% raw xsrf_form_html() %}
        <iframe name ="hframe" id="hframe" style=" display: none"></iframe >
    </form>
    <a href='./file/download'>Download uploaded file</a>
    <form target='_self' onsubmit="return inputMessage()">
        <span>Say something: </span>
        <input type='text' id='message'/>
        <input type='submit' value='Send'/>
    </form>
    <div id='messageBox'></div>
    <script src='/static/server.js'></script>
    <script>
        var messageBox = document.getElementById('messageBox');
        messageBox.prependChild = function(o){
            if (this.hasChildNodes()){
                this.insertBefore(o, this.firstChild);
            }else{
                this.appendChild(o);
            }
        }
        var messageText = document.getElementById('message');
        window.addEventListener('keydown', function(event){
            if (messageText != document.activeElement)
                server.keyDown(event.keyCode);
        })
        window.addEventListener('keyup', function(evnet){
            if (messageText != document.activeElement)
                server.keyUp(event.keyCode);
        })
        function inputMessage(){
            server.broadcast(messageText.value);
            messageText.value = '';
            return false;
        }
        function newMessage(msg){
            var div  = document.createElement('div');
            div.innerHTML = msg;
            messageBox.prependChild(div);
        }
        server.remote.setKeyDown(function(code){
            newMessage('Key Down ' + code);
        });
        server.remote.setKeyUp(function(code){
            newMessage('Key Up ' + code);
        });
        server.remote.setSwitchPress(function(id){
            newMessage('Switch Press ' + id);
        });
        server.remote.setUserChange(function(user){
            newMessage('user Change to ' + user);
            console.log(user);
        });
        server.remote.setLeave(function(){
            newMessage('FPGA leave');
        });
        server.remote.setFileUpload(function(info){
            newMessage('file received with size: ' + info.size);
        });
        server.remote.setFileProgram(function(){
            newMessage('file program.');
        });
        server.remote.setBroadcast(function(messageObj){
            var a = new Date();
            a.setTime(messageObj.timestamp * 1000);
            newMessage(a.toLocaleString() + ' ' + messageObj.nickname + ' : ' + messageObj.message);
        });
    </script>
</body>
</html>
